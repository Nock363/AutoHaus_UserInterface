<!DOCTYPE html>
<html>
<head>
  <title>Chart.js Zoom Example</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.1.1/dist/chartjs-plugin-zoom.min.js"></script>
</head>
<body>
  <canvas id="myChart"></canvas>
  <script>

    //get data path from url
    var url = new URL(window.location.href);
    

    var updateInterval = 1;

    //url looks like http://192.168.0.200:5000/static/chart.html?collection=DummyCollection0&length=1000
    var collection = url.searchParams.get("collection");
    var length = url.searchParams.get("length");
    var fetchURL = "/data/"+collection+"/" + length;
    //var updateURL = "/data/"+collection+"/" + 10;
    var updateURL = fetchURL;
    console.log("fetchURL: ", fetchURL);
    // var dataPath = url.searchParams.get("data");
    // var chartSize = url.searchParams.get("size");
    // var fetchURL = "/" + dataPath + "/" + chartSize;

    //length of data to be displayed
    var maxLength = length;

    console.log("maxLength: ", maxLength);

    var ctx = document.getElementById('myChart').getContext('2d');

    var chart = new Chart(ctx, {
                    type: 'line',
                    data: {},
                    options: {
                        animation: {
                            duration: 0 // Set duration to 0 to disable animation
                        },
                        plugins: {
                            zoom: {
                                zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'xy',
                                }
                            }
                        }
                    }
                });


    function createChart(url) {
        fetch(url)
            .then(response => response.json())
            .then(dataFromServer => {
                console.log("collections: ", dataFromServer);

                //Invert dataFromServer
                // dataFromServer = dataFromServer.reverse();

                // Erstelle eine Liste von Labels
                const labels = dataFromServer.map(datum => datum.time);

                // Erstelle eine Liste von Datensätzen für jeden Datentyp aus "data"
                const datasets = [];
                Object.keys(dataFromServer[0].data).forEach(typ => {
                    const datenArray = dataFromServer.map(datum => datum.data[typ]);
                    datasets.push({
                        label: typ,
                        data: datenArray,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        hidden: false
                    });
                });

                var data = {
                        labels: labels,
                        datasets: datasets
                };

                //only keep the last maxLength entries
                if (data.labels.length > maxLength) {
                    data.labels = data.labels.slice(data.labels.length - maxLength, data.labels.length);
                    data.datasets.forEach(dataset => {
                        dataset.data = dataset.data.slice(dataset.data.length - maxLength, dataset.data.length);
                    });
                }

                //get which data is selected
                var selectedData = [datasets.length];
                for (var i = 0; i < datasets.length; i++) {
                    selectedData[i] = chart.getDatasetMeta(i).hidden;
                }

                chart.data = data;

                //update data selection
                for (var i = 0; i < datasets.length; i++) {
                    chart.getDatasetMeta(i).hidden = selectedData[i];
                }

                chart.update();

                //update data selection
            

                //clear old chart
                // if (window.myChart != undefined) {
                //     window.myChart.destroy();
                // }

        });
    }

    createChart(fetchURL);

    //update chart in updateInterval seconds
    setInterval(function() {
        createChart(updateURL);
    }, updateInterval * 1000);

    
  </script>
</body>
</html>
