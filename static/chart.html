<!DOCTYPE html>
<html>
<head>
  <title>Chart.js Zoom Example</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.1.1/dist/chartjs-plugin-zoom.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@^2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@^1"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  
<div id="app" style="width:100%;max-width: 100%;" class="content">


    <div class="module shadow">
        <!--Slider to set moving average-->
        <div class="baseItem">
            <label for="movingAverageSlider">Moving Average:</label>
            <input type="number" class="shadowInset" id="movingAverageSlider" name="movingAverageSlider" min="1" max="100" value="1" step="1" oninput="updateMovAvg">
            <!-- <label for="startDate">Start Date:</label>
            <input type="datetime-local" class="shadowInset" id="startDate" name="startDate" value="2021-01-01T00:00" oninput="updateMovAvg">
            <label for="endDate">Start Date:</label>
            <input type="datetime-local" class="shadowInset" id="endDate" name="endDate" value="2021-01-01T00:00" oninput="updateMovAvg"> -->
            <button style="float:right" id="liveButton" onclick="setLiveUpdate()">Live update</button>

        </div>
        <div class="baseItem">
            
        </div>



    </div>
    <div class="module shadow" id="charts">
    </div>
    <canvas class="module shadow" id="myChart"></canvas>

</div>
  
  
  <script>

    //get data path from url
    var url = new URL(window.location.href);
    

    var updateInterval = 1;

    //url looks like http://192.168.0.200:5000/static/chart.html?collection=DummyCollection0&length=1000
    var collection = url.searchParams.get("collection");
    var length = url.searchParams.get("length");
    var fetchURL = "/data/"+collection+"/" + length;
    var updateURL = fetchURL;
    console.log("fetchURL: ", fetchURL);

    //length of data to be displayed
    var movAvgLength = 10;
    var chartsContainer = document.getElementById("charts");
    var charts = [];

    // var startDateInput = document.getElementById("startDate");
    // var endDateInput = document.getElementById("endDate");

    // //update end date to current date
    // setToCurrentTime(startDateInput);
    // setToCurrentTime(endDateInput);
    
    var liveButton = document.getElementById("liveButton");
    var updateLive = true;


    function setLiveUpdate(){
        if(updateLive){
            updateLive = false;
            liveButton.classList.add("disabledButton");
        }else{
            updateLive = true;
            liveButton.classList.remove("disabledButton");
        }
    }

    function setToCurrentTime(datetimeElement) {
        var now = new Date();
        var year = now.getFullYear();
        var month = String(now.getMonth() + 1).padStart(2, '0'); // Monat beginnt bei 0, daher +1
        var day = String(now.getDate()).padStart(2, '0');
        var hours = String(now.getHours()).padStart(2, '0');
        var minutes = String(now.getMinutes()).padStart(2, '0');

        var dateTimeString = year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
        datetimeElement.value = dateTimeString;
    }

    function createCharts(url) {
        fetch(url)
            .then(response => response.json())
            .then(dataFromServer => {
                console.log("collections: ", dataFromServer);

                //Invert dataFromServer
                dataFromServer = dataFromServer.reverse();

                // Erstelle eine Liste von Labels
                var datasets = createDataSets(dataFromServer);
                var labels = createLabels(dataFromServer);

                //create chart for each dataset
                datasets.forEach(dataset => {
                    var movAvg = createMovAvgDataSet(dataset,movAvgLength);
                    var chartObject = createChartCanvas(dataset.name,labels,[dataset,movAvg]);
                    chartsContainer.appendChild(chartObject.canvas);
                    charts.push(chartObject.chart);
                });

                
        });
    }

    function updateCharts(url) {
        fetch(url)
            .then(response => response.json())
            .then(dataFromServer => {
                console.log("collections: ", dataFromServer);

                //Invert dataFromServer
                dataFromServer = dataFromServer.reverse();

                // Erstelle eine Liste von Labels
                var datasets = createDataSets(dataFromServer);
                var labels = createLabels(dataFromServer);

                if(datasets.length != charts.length){
                    throw "datasets and charts have different length";
                    return;
                }

                //update every chart with new data
                for(var i = 0; i < datasets.length; i++){
                    
                    //get which data is selected
                    // var selectedData = [datasets.length];
                    // for (var i = 0; i < datasets.length; i++) {
                    //     selectedData[i] = chart.getDatasetMeta(i).hidden;
                    // }

                    var movAvg = createMovAvgDataSet(datasets[i],movAvgLength);
                    charts[i].data.labels = labels;

                    //safe old hidden state
                    
                    var dataHidden = (charts[i].getDatasetMeta(0).hidden == true);
                    var avgHidden = (charts[i].getDatasetMeta(1).hidden == true);
                    charts[i].data.datasets = [datasets[i],movAvg];
                    //restore old hidden state
                    charts[i].getDatasetMeta(0).hidden = dataHidden;
                    charts[i].getDatasetMeta(1).hidden = avgHidden;

                    charts[i].update();
                }

        });
    }


    function createChartCanvas(name,labels,datasets) {
        var chartCanvas = document.createElement('canvas');
        chartCanvas.id = name;
        //add chart to charts container
        var ctx = chartCanvas.getContext('2d');

        var chart = new Chart(ctx, {
                    type: 'line',
                    data: {labels: labels, datasets: datasets},
                        options: {
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'minute'
                                    }
                                }
                            },
                            animation: {
                                duration: 0 // Set duration to 0 to disable animation
                            },
                            plugins: {
                                zoom: {
                                    zoom: {
                                    wheel: {
                                        enabled: true,
                                    },
                                    pinch: {
                                        enabled: true
                                    },
                                    mode: 'xy',
                                    }
                                }
                            }
                        }
                    });

        return {"canvas": chartCanvas, "chart": chart};
    }

    function createDataSets(rawData){

        // Erstelle eine Liste von Datensätzen für jeden Datentyp aus "data"
        const datasets = [];
        Object.keys(rawData[0].data).forEach(typ => {
            const datenArray = rawData.map(datum => datum.data[typ]);
            datasets.push({
                label: typ,
                data: datenArray,
                borderColor: 'rgb(11 202 5)',
                backgroundColor: 'rgb(11 202 5)',
                hidden: false,
                pointRadius: 2
            });
        });
        return datasets;
    }

    function createLabels(rawData){
        
        return rawData.map(datum => new Date(datum.time));
    }

    function createMovAvgDataSet(dataset,avgSize){
        var inputData = dataset.data;
        var outputData = [];

        //TODO: check if avgSize is smaller than inputData.length
        
        var avg = 0;
        var size = 1;
        for(var i = 0; i < inputData.length; i++){
            
            if(i < avgSize){
                outputData.push(inputData[i]);
            }else{
                avg = 0;
                size = 0;
                for(var j = i - avgSize; j < i; j++){
                    avg += inputData[j];
                    size++;
                }
                avg = avg / size;
                outputData.push(avg);
            }
            

        }

        var outputDataSet = {
            label: dataset.label + " (avg)",
            data: outputData,
            borderColor: 'rgb(255 0 0)',
            backgroundColor: 'rgb(255 0 0)',
            hidden: false,
            pointRadius: 0.5
        };
        return outputDataSet;
    }

    createCharts(fetchURL);

    //update chart in updateInterval seconds
    setInterval(function() {
        if(updateLive){
            updateCharts(updateURL);
        }
    }, updateInterval * 5000);

    
  </script>
</body>
</html>
